name: DITA to SPA Transformation

# Trigger on pushes to the main branch or manual workflow dispatch
on:
  push:
    branches: [ main ]
    paths:
      - 'dita-source/**'        # Only run when DITA content changes
      - '.github/workflows/**'   # Or when workflow itself changes
  workflow_dispatch:            # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write           # Needed for GitHub Pages deployment
    steps:
      # Step 1: Checkout repository 
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Java (required for DITA-OT)
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # Step 3: Install DITA-OT
      - name: Set up DITA-OT
        run: |
          wget https://github.com/dita-ot/dita-ot/releases/download/4.0.2/dita-ot-4.0.2.zip
          unzip dita-ot-4.0.2.zip
          chmod +x dita-ot-4.0.2/bin/dita

      # Step 4: List DITA files for verification
      - name: List DITA files
        run: |
          echo "DITA files in repository:"
          find dita-source -name "*.dita" -o -name "*.ditamap" | sort
          echo "--------------------------------------"

      # Step 5: Transform DITA to HTML5
      - name: Transform DITA to HTML5
        run: |
          # Ensure path with spaces works correctly by quoting it
          ./dita-ot-4.0.2/bin/dita --input="dita-source/automotive.ditamap" --format=html5 --output=./site --nav-toc=partial
          echo "DITA transformation complete"
          
          # Create content directory for SPA fragments
          mkdir -p ./site/content
          
          # Debug information
          echo "Generated files:"
          find ./site -type f | sort

      # Step 6: Process HTML files into content fragments
      - name: Process HTML Content
        run: |
          # Process each HTML file to extract content only
          for file in ./site/*.html; do
            # Skip processing if this is the index.html file we'll create later
            if [[ "$file" == "./site/index.html" ]]; then
              continue
            fi
            
            filename=$(basename "$file")
            id="${filename%.html}"
            echo "Processing $filename (ID: $id)"
            
            # Extract content from file (body content excluding navigation)
            content=$(sed -n '/<body/,/<\/body>/p' "$file" | 
                      sed '/<body/d;/<\/body>/d' | 
                      awk '
                        BEGIN { skip=0; count=0; }
                        /<div class=".*\bnav\b.*">/ { skip=1; }
                        /<\/div>/ { if (skip==1) { skip=0; } }
                        { if (skip == 0) print $0; }
                      ')
            
            # Get title from the original file
            title=$(grep -o "<title>.*</title>" "$file" | sed 's/<title>\(.*\)<\/title>/\1/' | head -1)
            if [ -z "$title" ]; then
              # Create a title from the filename if none found
              title=$(echo "$id" | tr '_-' ' ' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1')
            fi
            
            # Create a clean HTML fragment file in the content directory
            echo "$content" > "./site/content/$id.html"
            
            # Add to the content manifest
            echo "  \"$id\": { \"title\": \"$title\" }," >> ./site/content-list.tmp
          done

      # Step 7: Create navigation configuration based on files found
      - name: Create Navigation Config
        run: |
          # Create directories for assets
          mkdir -p ./site/js ./site/css
          
          # Process DITAMAP to extract navigation
          # For now, we'll create a structure based on the filenames
          echo "// Navigation structure based on your DITA files" > ./site/js/navigation-config.js
          echo "const navigationConfig = [" >> ./site/js/navigation-config.js
          
          # Add automotive concepts section
          echo "  {" >> ./site/js/navigation-config.js
          echo "    id: \"automotive_concepts\"," >> ./site/js/navigation-config.js
          echo "    title: \"Automotive Concepts\"," >> ./site/js/navigation-config.js
          echo "    children: [" >> ./site/js/navigation-config.js
          echo "      { id: \"car_basics\", title: \"Car Basics\" }," >> ./site/js/navigation-config.js
          echo "      { id: \"car_history\", title: \"Car History\" }," >> ./site/js/navigation-config.js
          echo "      { id: \"car_types\", title: \"Car Types\" }" >> ./site/js/navigation-config.js
          echo "    ]" >> ./site/js/navigation-config.js
          echo "  }," >> ./site/js/navigation-config.js
          
          # Add components section
          echo "  {" >> ./site/js/navigation-config.js
          echo "    id: \"car_components\"," >> ./site/js/navigation-config.js
          echo "    title: \"Car Components\"," >> ./site/js/navigation-config.js
          echo "    children: [" >> ./site/js/navigation-config.js
          echo "      { id: \"electrical\", title: \"Electrical Systems\" }," >> ./site/js/navigation-config.js
          echo "      { id: \"engines\", title: \"Engine Systems\" }," >> ./site/js/navigation-config.js
          echo "      { id: \"evs\", title: \"Electric Vehicles\" }," >> ./site/js/navigation-config.js
          echo "      { id: \"brakes\", title: \"Braking Systems\" }" >> ./site/js/navigation-config.js
          echo "    ]" >> ./site/js/navigation-config.js
          echo "  }," >> ./site/js/navigation-config.js
          
          # Add maintenance section
          echo "  {" >> ./site/js/navigation-config.js
          echo "    id: \"maintenance\"," >> ./site/js/navigation-config.js
          echo "    title: \"Maintenance\"," >> ./site/js/navigation-config.js
          echo "    children: [" >> ./site/js/navigation-config.js
          echo "      { id: \"basic_maintenance\", title: \"Basic Maintenance\" }," >> ./site/js/navigation-config.js
          echo "      { id: \"car_maintenance\", title: \"Car Maintenance\" }," >> ./site/js/navigation-config.js
          echo "      { id: \"emergency_repairs\", title: \"Emergency Repairs\" }" >> ./site/js/navigation-config.js
          echo "    ]" >> ./site/js/navigation-config.js
          echo "  }" >> ./site/js/navigation-config.js
          
          # Close the array
          echo "];" >> ./site/js/navigation-config.js
          
          # Create content manifest from processed content
          echo "// Content manifest - maps IDs to content files" > ./site/js/content-manifest.js
          echo "const contentManifest = {" >> ./site/js/content-manifest.js
          
          # Add entries from our temp file if it exists
          if [ -f "./site/content-list.tmp" ]; then
            cat ./site/content-list.tmp >> ./site/js/content-manifest.js
          fi
          
          # Close the manifest object with default entry
          echo "  \"default\": { \"title\": \"Automotive Documentation\" }" >> ./site/js/content-manifest.js
          echo "};" >> ./site/js/content-manifest.js
          
          # Clean up temp file
          rm -f ./site/content-list.tmp

      # Step 8: Create SPA CSS
      - name: Create SPA CSS
        run: |
          cat > ./site/css/style.css << 'EOF'
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            display: flex;
            height: 100vh;
            width: 100%;
            overflow: hidden;
          }
          
          .sidebar {
            width: 250px;
            background-color: #f5f5f5;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid #ddd;
          }
          
          .main-content {
            flex: 1;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
          }
          
          .sidebar h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
          }
          
          .sidebar ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 15px;
          }
          
          .sidebar ul ul {
            padding-left: 20px;
            margin-top: 5px;
          }
          
          .sidebar li {
            margin-bottom: 8px;
          }
          
          .sidebar a {
            color: #2c3e50;
            text-decoration: none;
            display: block;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            cursor: pointer;
          }
          
          .sidebar a:hover {
            background-color: #e0e0e0;
          }
          
          .sidebar a.active {
            background-color: #dbeafe;
            font-weight: bold;
          }
          
          /* Improve readability in main content */
          .main-content h1, .main-content h2, .main-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
          }
          
          .main-content p {
            margin-bottom: 1em;
          }
          
          .main-content img {
            max-width: 100%;
            height: auto;
          }
          
          #loading {
            display: none;
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
          }
          
          .loading #loading {
            display: block;
          }
          
          /* Add loading animation */
          .loading #content::before {
            content: "";
            display: block;
            width: 40px;
            height: 40px;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -20px;
            margin-left: -20px;
            border-radius: 50%;
            border: 3px solid #f3f3f3;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
          }
          
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
          
          /* Error styling */
          .error {
            background-color: #fff8f8;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin-bottom: 20px;
            color: #333;
          }
          
          .error h2 {
            color: #e74c3c;
            margin-top: 0;
          }
          
          /* Responsive design for mobile */
          @media (max-width: 768px) {
            body {
              flex-direction: column;
              height: auto;
            }
            
            .sidebar {
              width: 100%;
              height: auto;
              max-height: 40vh;
            }
            
            .main-content {
              height: auto;
              min-height: 60vh;
            }
          }
          EOF

      # Step 9: Create SPA JavaScript Application
      - name: Create SPA Application
        run: |
          cat > ./site/js/app.js << 'EOF'
          // SPA Application with path handling for GitHub Pages
          
          // DOM Elements
          const contentEl = document.getElementById('content');
          const contentTitleEl = document.getElementById('content-title');
          const navigationEl = document.getElementById('navigation');
          
          // Base path handling for GitHub Pages
          const getBasePath = () => {
            // For GitHub Pages repository sites, we need to include the repo name in paths
            if (location.hostname.includes('github.io')) {
              const pathSegments = location.pathname.split('/');
              if (pathSegments.length > 1) {
                return '/' + pathSegments[1];
              }
            }
            return '';
          };
          
          // Current state
          let currentPage = null;
          const basePath = getBasePath();
          
          // Debug logging function
          function debug(message, data) {
            console.log(`[DITA-SPA] ${message}`, data || '');
          }
          
          // Initialize the application
          function initApp() {
            debug('Initializing app with base path:', basePath);
            
            // Render navigation
            renderNavigation(navigationConfig);
            
            // Set up event listeners
            window.addEventListener('popstate', handlePopState);
            
            // Load initial page based on URL or default
            const initialPageId = getPageIdFromUrl() || "automotive_concepts";
            debug('Initial page ID:', initialPageId);
            navigateToPage(initialPageId, false);
          }
          
          // Render the navigation menu
          function renderNavigation(items, parentEl = navigationEl) {
            debug('Rendering navigation items:', items.length);
            const ul = document.createElement('ul');
            
            items.forEach(item => {
              const li = document.createElement('li');
              
              const a = document.createElement('a');
              a.textContent = item.title;
              a.setAttribute('data-id', item.id);
              a.href = `#${item.id}`;
              a.addEventListener('click', (e) => {
                e.preventDefault();
                navigateToPage(item.id);
              });
              li.appendChild(a);
              
              // Recursively render children if any
              if (item.children && item.children.length > 0) {
                renderNavigation(item.children, li);
              }
              
              ul.appendChild(li);
            });
            
            parentEl.appendChild(ul);
          }
          
          // Navigate to a specific page
          function navigateToPage(pageId, pushState = true) {
            debug('Navigating to page:', pageId);
            
            // Update active state in navigation
            updateActiveNavItem(pageId);
            
            // Update the URL
            if (pushState) {
              history.pushState({ pageId }, '', `#${pageId}`);
            }
            
            // Show loading indicator
            document.body.classList.add('loading');
            
            // Update current page
            currentPage = pageId;
            
            // Load content
            loadContent(pageId)
              .then(content => {
                // Update title
                const title = getPageTitle(pageId);
                contentTitleEl.textContent = title;
                document.title = title;
                
                // Update content
                contentEl.innerHTML = content;
                
                // Hide loading indicator
                document.body.classList.remove('loading');
                debug('Content loaded successfully for:', pageId);
              })
              .catch(error => {
                console.error('Error loading content:', error);
                contentEl.innerHTML = `
                  <div class="error">
                    <h2>Failed to Load Content</h2>
                    <p>The requested content "${pageId}" could not be loaded.</p>
                    <p>Technical details: ${error.message}</p>
                    <p>Base path: ${basePath}</p>
                    <p>Attempted URL: ${basePath}/content/${pageId}.html</p>
                  </div>
                `;
                document.body.classList.remove('loading');
              });
          }
          
          // Load content for a page
          async function loadContent(pageId) {
            debug('Attempting to load content for:', pageId);
            
            try {
              // Construct the correct path using the base path
              const contentPath = `${basePath}/content/${pageId}.html`;
              debug('Fetching from URL:', contentPath);
              
              const response = await fetch(contentPath);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const content = await response.text();
              debug('Content length:', content.length);
              
              // Additional check for empty content
              if (!content || content.trim() === '') {
                throw new Error('Content file exists but is empty');
              }
              
              return content;
            } catch (error) {
              debug('Error in loadContent:', error.message);
              
              // Try alternative ID formats if the first attempt fails
              // This helps with inconsistencies in ID naming between DITA and HTML
              const alternativeId = pageId
                .replace(/_/g, '-')  // Try with hyphens instead of underscores
                .replace(/-/g, '_'); // Or vice versa
              
              if (alternativeId !== pageId) {
                debug('Trying alternative ID format:', alternativeId);
                try {
                  const contentPath = `${basePath}/content/${alternativeId}.html`;
                  const response = await fetch(contentPath);
                  if (response.ok) {
                    const content = await response.text();
                    if (content && content.trim() !== '') {
                      return content;
                    }
                  }
                } catch (altError) {
                  debug('Alternative ID also failed:', altError.message);
                }
              }
              
              throw error; // Re-throw to be handled by the caller
            }
          }
          
          // Update active state in navigation
          function updateActiveNavItem(pageId) {
            // Remove active class from all nav items
            const allNavItems = document.querySelectorAll('.sidebar a');
            allNavItems.forEach(item => item.classList.remove('active'));
            
            // Add active class to current page nav item
            const activeItem = document.querySelector(`.sidebar a[data-id="${pageId}"]`);
            if (activeItem) {
              activeItem.classList.add('active');
              
              // Expand parent sections if needed
              let parent = activeItem.parentElement;
              while (parent && parent !== navigationEl) {
                if (parent.tagName === 'LI') {
                  const parentLink = parent.querySelector('a');
                  if (parentLink) {
                    parentLink.classList.add('active');
                  }
                }
                parent = parent.parentElement;
              }
            } else {
              debug('Warning: No navigation item found for:', pageId);
            }
          }
          
          // Handle popstate event (browser back/forward)
          function handlePopState(event) {
            const pageId = event.state?.pageId || getPageIdFromUrl() || 'default';
            debug('Popstate event, loading page:', pageId);
            navigateToPage(pageId, false);
          }
          
          // Get page ID from URL hash
          function getPageIdFromUrl() {
            return window.location.hash.substring(1) || null;
          }
          
          // Get page title from content manifest
          function getPageTitle(pageId) {
            if (!contentManifest[pageId]) {
              debug('Warning: No manifest entry for:', pageId);
              return pageId.split(/[-_]/).map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
              ).join(' ');
            }
            return contentManifest[pageId].title;
          }
          
          // Check content directory structure on load
          async function checkContentStructure() {
            try {
              debug('Checking for default content file...');
              const response = await fetch(`${basePath}/content/default.html`);
              if (response.ok) {
                debug('Default content exists, structure seems correct');
              } else {
                console.warn('Default content not found, may indicate path issues');
              }
            } catch (error) {
              console.error('Error checking content structure:', error);
            }
          }
          
          // Initialize the app when DOM is ready
          document.addEventListener('DOMContentLoaded', () => {
            debug('DOM loaded, initializing app...');
            checkContentStructure();
            initApp();
          });
          
          // Display loading error if content doesn't load within 5 seconds
          setTimeout(() => {
            if (document.body.classList.contains('loading')) {
              debug('Still loading after timeout, may indicate a problem');
              const errorMsg = document.createElement('div');
              errorMsg.className = 'loading-timeout-error';
              errorMsg.innerHTML = `
                <h2>Content Loading Issue</h2>
                <p>The content is taking too long to load. This may indicate a path or configuration issue.</p>
                <p>Current base path: ${basePath}</p>
                <p>Current page ID: ${currentPage}</p>
                <p>Check the browser console for more details.</p>
                <p>Try adding "?debug=true" to the URL for more information.</p>
              `;
              contentEl.appendChild(errorMsg);
            }
          }, 5000);
          EOF

      # Step 10: Create main index.html
      - name: Create Index HTML
        run: |
          cat > ./site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            
            <!-- Base path handling for GitHub Pages -->
            <script>
              // Dynamically set the base href based on deployment environment
              (function() {
                // For GitHub Pages repository sites
                if (location.hostname.includes('github.io')) {
                  const pathSegments = location.pathname.split('/');
                  if (pathSegments.length > 1) {
                    const basePath = '/' + pathSegments[1];
                    document.write('<base href="' + basePath + '/">');
                    console.log('[DITA-SPA] Base path set to:', basePath);
                  }
                }
              })();
              
              // Handle redirects from 404 page 
              (function() {
                var redirect = sessionStorage.redirect;
                delete sessionStorage.redirect;
                if (redirect && redirect !== location.href) {
                  var cleanPath = redirect.split('/').pop();
                  if (cleanPath) {
                    history.replaceState(null, null, "#" + cleanPath.replace('.html', ''));
                    console.log('[DITA-SPA] Redirected from:', redirect);
                  }
                }
              })();
            </script>
            
            <title>Automotive Documentation</title>
            <link rel="stylesheet" href="css/style.css">
            
            <!-- Error handling and diagnostics -->
            <script>
              window.onerror = function(message, source, lineno, colno, error) {
                console.error('[DITA-SPA] Error:', message, 'at', source, lineno, colno);
                document.getElementById('error-display') && 
                  (document.getElementById('error-display').innerHTML = 
                    '<p>Error: ' + message + '</p><p>Source: ' + source + ':' + lineno + '</p>');
                return false;
              };
            </script>
          </head>
          <body>
            <div class="sidebar">
              <h2>Navigation</h2>
              <div id="navigation"></div>
            </div>
            <div class="main-content">
              <h1 id="content-title">Loading...</h1>
              <div id="loading">Loading content...</div>
              <div id="content">
                <!-- Content will load here -->
                <!-- Initial loading message -->
                <div class="initial-loading">
                  <p>Initializing documentation viewer...</p>
                  <p><small>If content doesn't appear in a few seconds, check the console for errors.</small></p>
                </div>
              </div>
              <div id="error-display"></div>
            </div>
            
            <!-- Debug panel (hidden by default, can be shown with ?debug=true in URL) -->
            <div id="debug-panel" style="display: none; position: fixed; bottom: 0; right: 0; background: #f0f0f0; padding: 10px; border: 1px solid #ccc; max-width: 300px; max-height: 200px; overflow: auto; font-size: 11px;">
              <h4>Debug Information</h4>
              <div id="debug-content"></div>
            </div>
            
            <!-- Add debug panel toggle -->
            <script>
              if (location.search.includes('debug=true')) {
                document.getElementById('debug-panel').style.display = 'block';
                window.debugLog = function(msg) {
                  const panel = document.getElementById('debug-content');
                  if (panel) {
                    const line = document.createElement('div');
                    line.textContent = new Date().toISOString().substr(11, 8) + ': ' + msg;
                    panel.appendChild(line);
                    panel.scrollTop = panel.scrollHeight;
                  }
                  console.log('[DEBUG] ' + msg);
                };
                debugLog('Debug mode enabled');
                debugLog('URL: ' + location.href);
              } else {
                window.debugLog = function() {};
              }
            </script>
            
            <!-- Load JavaScript files -->
            <script src="js/navigation-config.js"></script>
            <script src="js/content-manifest.js"></script>
            <script src="js/app.js"></script>
          </body>
          </html>
          EOF

      # Step 11: Create 404.html page for SPA routing
      - name: Create 404 Page for SPA Routing
        run: |
          cat > ./site/404.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Redirecting...</title>
            <script>
              // Store the requested URL for processing after redirect
              sessionStorage.redirect = location.href;
              
              // Dynamically determine the correct base path
              function getBasePath() {
                if (location.hostname.includes('github.io')) {
                  const pathSegments = location.pathname.split('/');
                  if (pathSegments.length > 1) {
                    return '/' + pathSegments[1];
                  }
                }
                return '';
              }
              
              // Redirect to the main site with the correct base path
              const basePath = getBasePath();
              window.location.href = basePath + '/';
              
              // Log for debugging
              console.log('404 Redirect - Original URL:', location.href);
              console.log('404 Redirect - Base Path:', basePath);
              console.log('404 Redirect - Redirecting to:', basePath + '/');
            </script>
          </head>
          <body>
            <div style="text-align: center; font-family: Arial, sans-serif; margin-top: 100px;">
              <h1>Redirecting to documentation...</h1>
              <p>If you are not redirected automatically, <a href="/">click here</a>.</p>
            </div>
          </body>
          </html>
          EOF

      # Step 12: Create default content and placeholders
      - name: Create Default Content
        run: |
          # Create default/fallback content page
          mkdir -p ./site/content
          cat > ./site/content/default.html << 'EOF'
          <h1>Automotive Documentation</h1>
          <p>Welcome to the automotive documentation. Please select a topic from the navigation menu.</p>
          <p>This documentation provides information about various aspects of automotive technology, maintenance, and repair.</p>
          EOF
          
          # Create empty placeholder content files for each navigation item
          # This ensures we have at least something to display if the DITA transformation didn't create all files
          for topic in automotive_concepts car_basics car_history car_types car_components electrical engines evs brakes maintenance basic_maintenance car_maintenance emergency_repairs; do
            if [ ! -f "./site/content/$topic.html" ]; then
              echo "Creating placeholder content for $topic"
              
              # Create title from ID
              title=$(echo "$topic" | tr '_-' ' ' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1')
              
              # Create placeholder content
              cat > "./site/content/$topic.html" << EOF
          <h1>${title}</h1>
          <p>Content for this section is currently under development.</p>
          <p>This placeholder was automatically generated because the DITA content wasn't found or couldn't be processed.</p>
          EOF
            fi
          done

      # Step 13: Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          force_orphan: true  # Creates a clean commit without history