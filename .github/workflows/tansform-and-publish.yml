name: DITA to SPA Transformation

# Trigger on pushes to the main branch or manual workflow dispatch
on:
  push:
    branches: [ main ]
    paths:
      - 'dita-source/**'        # Only run when DITA content changes
      - '.github/workflows/**'   # Or when workflow itself changes
  workflow_dispatch:            # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write           # Needed for GitHub Pages deployment
    steps:
      # Step 1: Checkout repository 
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Java (required for DITA-OT)
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # Step 3: Install DITA-OT
      - name: Set up DITA-OT
        run: |
          wget https://github.com/dita-ot/dita-ot/releases/download/4.0.2/dita-ot-4.0.2.zip
          unzip dita-ot-4.0.2.zip
          chmod +x dita-ot-4.0.2/bin/dita

      # Step 4: List DITA files for verification (FIXED path handling for spaces)
      - name: Analyze DITA Files
        run: |
          echo "DITA files in repository:"
          find dita-source -name "*.dita" -o -name "*.ditamap" | sort
          
          echo "--------------------------------------"
          echo "DITA file content samples:"
          # Fix: Properly handle paths with spaces by using find with -exec
          find dita-source -name "*.dita" -type f | head -3 | while read -r file; do
            echo "==== $file (first 20 lines) ===="
            head -20 "$file" || echo "Unable to read file"
            echo ""
          done

      # Step 5: Transform DITA to HTML5
      - name: Transform DITA to HTML5
        run: |
          # Always quote paths that might contain spaces
          ./dita-ot-4.0.2/bin/dita --input="dita-source/automotive.ditamap" --format=html5 --output="./site" \
            --nav-toc=partial \
            --args.copycss=yes \
            --args.css=style.css \
            --args.csspath=css \
            --args.cssroot=./site/css \
            --args.breadcrumbs=no \
            --args.gen.task.lbl=NO \
            --args.xhtml.classattr=yes
          
          echo "DITA transformation complete"
          
          # Create content directory for SPA fragments
          mkdir -p ./site/content
          
          # Debug information
          echo "Generated files:"
          find ./site -type f | sort

      # Step 6: Process HTML files to extract FULL content
      - name: Process HTML Content
        run: |
          # Create content directory
          mkdir -p ./site/content
          
          # Process each HTML file to extract complete content
          find ./site -name "*.html" -type f | grep -v "/content/" | while read -r file; do
            # Skip processing if this is the index.html file we'll create later
            if [[ "$file" == "./site/index.html" ]]; then
              continue
            fi
            
            filename=$(basename "$file")
            id="${filename%.html}"
            echo "Processing $filename (ID: $id)"
            
            # Extract title from the original file
            title=$(grep -o "<title>.*</title>" "$file" | sed 's/<title>\(.*\)<\/title>/\1/' | head -1)
            if [ -z "$title" ]; then
              # Create a title from the filename if none found
              title=$(echo "$id" | tr '_-' ' ' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1')
            fi
            
            # IMPROVED CONTENT EXTRACTION - capture the entire main content div
            content=$(sed -n '/<main/,/<\/main>/p' "$file" 2>/dev/null || 
                     sed -n '/<div class="body/,/<\/div>/p' "$file" 2>/dev/null ||
                     sed -n '/<body/,/<\/body>/p' "$file" | 
                     sed '/<body/d;/<\/body>/d;/<header/,/<\/header>/d;/<nav/,/<\/nav>/d;/<footer/,/<\/footer>/d')
            
            # Count content size to verify quality
            content_size=${#content}
            echo "Content size for $id: $content_size bytes"
            
            # Save with all possible filename variations to ensure accessibility
            echo "$content" > "./site/content/$id.html"
            # Create hyphenated version if using underscores
            if [[ "$id" == *"_"* ]]; then
              hyphen_id="${id//_/-}"
              echo "$content" > "./site/content/$hyphen_id.html"
              echo "Created alternate hyphenated version: $hyphen_id.html"
            fi
            # Create underscore version if using hyphens
            if [[ "$id" == *"-"* ]]; then
              underscore_id="${id//-/_}"
              echo "$content" > "./site/content/$underscore_id.html"
              echo "Created alternate underscore version: $underscore_id.html"
            fi
            
            # Add to the content manifest
            echo "  \"$id\": { \"title\": \"$title\" }," >> ./site/content-list.tmp
          done

      # Step 7: Direct DITA content extraction (FIXED for paths with spaces)
      - name: Direct DITA Content Extraction
        run: |
          echo "Extracting content directly from DITA files as backup..."
          
          # Create a function to convert DITA to simplified HTML
          dita_to_html() {
            local file="$1"
            local output_file="$2"
            local title="$3"
            local topic_id=$(basename "$file" .dita)
            
            echo "Processing DITA file: $file"
            
            # Extract content using grep/sed with proper quoting
            content="<h1>$title</h1>\n<div class=\"topic-content\">"
            
            # Extract paragraphs
            paragraphs=$(grep -o "<p>.*</p>" "$file" || echo "")
            content="${content}\n${paragraphs}"
            
            # Extract lists if any
            lists=$(sed -n '/<[ou]l>/,/<\/[ou]l>/p' "$file" || echo "")
            content="${content}\n${lists}"
            
            # Extract tables if any
            tables=$(sed -n '/<table>/,/<\/table>/p' "$file" || echo "")
            content="${content}\n${tables}"
            
            # Close the content div
            content="${content}\n</div>"
            
            # Write to file
            echo -e "$content" > "$output_file"
            echo "Created direct extraction: $output_file"
          }
          
          # Process each DITA file for direct extraction (using find and proper quoting)
          find dita-source -name "*.dita" -type f | while read -r dita_file; do
            # Get filename without extension and with normalizing special characters
            base_name=$(basename "$dita_file" .dita | tr ' ' '_')
            
            # Extract title from DITA file
            title=$(grep -o "<title>.*</title>" "$dita_file" | head -1 | sed 's/<title>\(.*\)<\/title>/\1/')
            if [ -z "$title" ]; then
              title=$(echo "$base_name" | tr '_-' ' ' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1')
            fi
            
            # Create content using our function
            dita_to_html "$dita_file" "./site/content/direct_${base_name}.html" "$title"
            
            # Create all naming variations to ensure we catch the right one
            hyphen_name="${base_name//_/-}"
            if [ ! -f "./site/content/${base_name}.html" ]; then
              cp "./site/content/direct_${base_name}.html" "./site/content/${base_name}.html"
              echo "Created backup content for: ${base_name}.html"
            fi
            if [ ! -f "./site/content/${hyphen_name}.html" ]; then
              cp "./site/content/direct_${base_name}.html" "./site/content/${hyphen_name}.html"
              echo "Created backup content for: ${hyphen_name}.html"
            fi
          done

      # Step 8: Create rich placeholder content
      - name: Create Rich Placeholder Content 
        run: |
          # Create a map of topic IDs to rich content
          declare -A topic_content
          
          topic_content["automotive-theories"]="<h1>Automotive Theories</h1>
          <div class=\"topic-content\">
          <p>Automotive theory encompasses the fundamental principles behind how vehicles operate, including mechanical, electrical, and physical concepts that govern vehicle design and function.</p>
          <p>Understanding automotive theory provides the groundwork for diagnosing issues, performing repairs, and appreciating vehicle engineering innovations.</p>
          <p>From thermodynamics in engines to electrical principles in modern electronic systems, automotive theory spans numerous scientific disciplines applied to transportation technology.</p>
          </div>"
          
          topic_content["major-vehicle-components"]="<h1>Major Vehicle Components</h1>
          <div class=\"topic-content\">
          <p>An overview of the primary systems and components in modern vehicles.</p>
          <p>Modern vehicles integrate numerous interconnected components and systems that work together to provide safe, efficient transportation.</p>
          <p>These components can be organized into several major categories:</p>
          <ul>
            <li>Powertrain components (engine, transmission, drivetrain)</li>
            <li>Chassis components (frame, suspension, steering, brakes)</li>
            <li>Electrical systems (battery, alternator, wiring, electronics)</li>
            <li>Body components (exterior panels, interior features, safety systems)</li>
          </ul>
          <p>Understanding these major vehicle components is essential for proper maintenance, troubleshooting, and repair procedures.</p>
          </div>"
          
          topic_content["engine-systems"]="<h1>Engine Systems</h1>
          <div class=\"topic-content\">
          <p>The engine is the heart of conventional vehicles, converting fuel into mechanical energy through a series of precisely controlled combustion events.</p>
          <p>Modern engines consist of several integrated systems working together:</p>
          <ul>
            <li><strong>Fuel System</strong> - Delivers the precise amount of fuel required for combustion</li>
            <li><strong>Air Intake System</strong> - Filters and delivers air needed for combustion</li>
            <li><strong>Ignition System</strong> - Initiates the combustion process with precisely timed sparks</li>
            <li><strong>Cooling System</strong> - Maintains optimal engine temperature</li>
            <li><strong>Lubrication System</strong> - Reduces friction between moving parts</li>
            <li><strong>Exhaust System</strong> - Removes and treats combustion byproducts</li>
          </ul>
          <p>These systems are monitored and controlled by sophisticated engine management computers in modern vehicles.</p>
          </div>"
          
          topic_content["electrical-systems"]="<h1>Electrical Systems</h1>
          <div class=\"topic-content\">
          <p>Vehicle electrical systems have evolved from simple circuits to complex networks that control virtually every aspect of vehicle operation.</p>
          <p>Key components include:</p>
          <ul>
            <li><strong>Battery</strong> - Stores electrical energy and provides power when the engine is off</li>
            <li><strong>Alternator</strong> - Generates electricity while the engine is running</li>
            <li><strong>Starter</strong> - Initiates engine operation using electrical power</li>
            <li><strong>Wiring Harnesses</strong> - Connect all electrical components</li>
            <li><strong>Electronic Control Units (ECUs)</strong> - Computer modules that control vehicle systems</li>
            <li><strong>Sensors</strong> - Provide real-time data to ECUs about vehicle conditions</li>
            <li><strong>Actuators</strong> - Convert electrical signals into mechanical movements</li>
          </ul>
          <p>Modern vehicles may contain dozens of microprocessors and kilometers of wiring to support advanced features and functions.</p>
          </div>"
          
          topic_content["electric-vehicles"]="<h1>Electric Vehicles</h1>
          <div class=\"topic-content\">
          <p>Electric vehicles (EVs) represent a fundamental shift in automotive technology, replacing traditional internal combustion engines with electric propulsion systems.</p>
          <p>Key components specific to electric vehicles include:</p>
          <ul>
            <li><strong>Battery Pack</strong> - High-capacity energy storage system</li>
            <li><strong>Electric Motor(s)</strong> - Convert electrical energy to mechanical power</li>
            <li><strong>Power Electronics</strong> - Control electricity flow between battery and motor</li>
            <li><strong>Charging System</strong> - Allows the battery to be recharged from external sources</li>
            <li><strong>Thermal Management System</strong> - Maintains optimal temperature for battery and electronics</li>
            <li><strong>Regenerative Braking</strong> - Recovers energy during deceleration</li>
          </ul>
          <p>EVs offer several advantages including zero tailpipe emissions, lower operating costs, and reduced maintenance requirements.</p>
          </div>"
          
          topic_content["braking-systems"]="<h1>Braking Systems</h1>
          <div class=\"topic-content\">
          <p>Vehicle braking systems are critical safety components that convert the vehicle's kinetic energy into heat through friction.</p>
          <p>Modern braking systems typically include:</p>
          <ul>
            <li><strong>Master Cylinder</strong> - Converts pedal force into hydraulic pressure</li>
            <li><strong>Brake Lines</strong> - Carry hydraulic fluid to wheel assemblies</li>
            <li><strong>Calipers (disc brakes)</strong> - Apply pressure to brake pads against rotors</li>
            <li><strong>Wheel Cylinders (drum brakes)</strong> - Apply pressure to brake shoes against drums</li>
            <li><strong>Anti-lock Braking System (ABS)</strong> - Prevents wheel lockup during heavy braking</li>
            <li><strong>Electronic Stability Control</strong> - Works with ABS to maintain vehicle control</li>
          </ul>
          <p>Advances in braking technology include electronic brake-force distribution, brake assist, and autonomous emergency braking systems.</p>
          </div>"
          
          topic_content["history-of-automobiles"]="<h1>History of Automobiles</h1>
          <div class=\"topic-content\">
          <p>The development of automobiles has transformed human society since their inception in the late 19th century.</p>
          <p>Key milestones in automotive history include:</p>
          <ul>
            <li><strong>1886</strong> - Karl Benz patents the first practical automobile with internal combustion engine</li>
            <li><strong>1908</strong> - Ford Model T introduces mass production techniques</li>
            <li><strong>1913</strong> - Ford's moving assembly line revolutionizes manufacturing</li>
            <li><strong>1930s-1940s</strong> - Advancements in streamlining, suspension, and power</li>
            <li><strong>1950s-1960s</strong> - Era of American automotive styling and performance</li>
            <li><strong>1970s</strong> - Oil crisis drives focus on fuel efficiency</li>
            <li><strong>1980s-1990s</strong> - Computerization and electronics revolution</li>
            <li><strong>2000s-Present</strong> - Focus on safety, efficiency, connectivity, and electrification</li>
          </ul>
          <p>Each era has contributed innovations that shaped both automotive design and broader society.</p>
          </div>"
          
          # Create rich placeholder content for each topic
          for topic_id in "${!topic_content[@]}"; do
            content="${topic_content[$topic_id]}"
            
            # Only create if file doesn't exist or is very small
            if [ ! -f "./site/content/${topic_id}.html" ] || [ $(stat -c%s "./site/content/${topic_id}.html") -lt 200 ]; then
              echo "$content" > "./site/content/${topic_id}.html"
              echo "Created rich placeholder content for: ${topic_id}.html"
            fi
            
            # Create alternate versions with underscores
            underscore_id="${topic_id//-/_}"
            if [ "$underscore_id" != "$topic_id" ]; then
              if [ ! -f "./site/content/${underscore_id}.html" ] || [ $(stat -c%s "./site/content/${underscore_id}.html") -lt 200 ]; then
                echo "$content" > "./site/content/${underscore_id}.html"
                echo "Created rich placeholder with underscores: ${underscore_id}.html"
              fi
            fi
            
            # Handle special cases for short names
            case "$topic_id" in
              "engine-systems")
                echo "$content" > "./site/content/engines.html"
                echo "Created special case content: engines.html"
                ;;
              "electric-vehicles")
                echo "$content" > "./site/content/evs.html"
                echo "Created special case content: evs.html"
                ;;
              "braking-systems")
                echo "$content" > "./site/content/brakes.html"
                echo "Created special case content: brakes.html"
                ;;
            esac
          done

      # Step 9: Create navigation configuration exactly matching screenshot
      - name: Create Navigation Config
        run: |
          mkdir -p ./site/js ./site/css
          
          # Create navigation structure exactly matching the screenshot
          cat > ./site/js/navigation-config.js << 'EOF'
          // Navigation structure based on your DITA files
          const navigationConfig = [
            {
              id: "automotive-theories",
              title: "Automotive Theories",
              children: [
                { id: "history-of-automobiles", title: "History of Automobiles" },
                { id: "types-of-vehicles", title: "Types of Vehicles" },
                { id: "automobile-fundamentals", title: "Automobile Fundamentals" },
                { 
                  id: "major-vehicle-components", 
                  title: "Major Vehicle Components",
                  children: [
                    { id: "electrical-systems", title: "Electrical Systems" },
                    { id: "engine-systems", title: "Engine Systems" },
                    { id: "electric-vehicles", title: "Electric Vehicles" },
                    { id: "braking-systems", title: "Braking Systems" }
                  ]
                }
              ]
            },
            { id: "basic-maintenance", title: "Basic Maintenance" },
            { id: "vehicle-maintenance", title: "Vehicle Maintenance" },
            { id: "emergency-repairs", title: "Emergency Repairs" }
          ];
          EOF
          
          # Create content manifest from processed content
          echo "// Content manifest - maps IDs to content files" > ./site/js/content-manifest.js
          echo "const contentManifest = {" >> ./site/js/content-manifest.js
          
          # Add entries from our temp file if it exists
          if [ -f "./site/content-list.tmp" ]; then
            cat ./site/content-list.tmp >> ./site/js/content-manifest.js
          fi
          
          # Add specific ID mappings to ensure all navigation items have content
          echo "  \"automotive-theories\": { \"title\": \"Automotive Theories\" }," >> ./site/js/content-manifest.js
          echo "  \"major-vehicle-components\": { \"title\": \"Major Vehicle Components\" }," >> ./site/js/content-manifest.js
          echo "  \"history-of-automobiles\": { \"title\": \"History of Automobiles\" }," >> ./site/js/content-manifest.js
          echo "  \"types-of-vehicles\": { \"title\": \"Types of Vehicles\" }," >> ./site/js/content-manifest.js
          echo "  \"automobile-fundamentals\": { \"title\": \"Automobile Fundamentals\" }," >> ./site/js/content-manifest.js
          echo "  \"electrical-systems\": { \"title\": \"Electrical Systems\" }," >> ./site/js/content-manifest.js
          echo "  \"engine-systems\": { \"title\": \"Engine Systems\" }," >> ./site/js/content-manifest.js
          echo "  \"electric-vehicles\": { \"title\": \"Electric Vehicles\" }," >> ./site/js/content-manifest.js
          echo "  \"braking-systems\": { \"title\": \"Braking Systems\" }," >> ./site/js/content-manifest.js
          echo "  \"basic-maintenance\": { \"title\": \"Basic Maintenance\" }," >> ./site/js/content-manifest.js
          echo "  \"vehicle-maintenance\": { \"title\": \"Vehicle Maintenance\" }," >> ./site/js/content-manifest.js
          echo "  \"emergency-repairs\": { \"title\": \"Emergency Repairs\" }," >> ./site/js/content-manifest.js
          
          # Close the manifest object with default entry
          echo "  \"default\": { \"title\": \"Automotive Documentation\" }" >> ./site/js/content-manifest.js
          echo "};" >> ./site/js/content-manifest.js
          
          # Clean up temp file
          rm -f ./site/content-list.tmp

      # Step 10: Create ID mapping function to handle filename variations
      - name: Create ID Mapping Function
        run: |
          cat > ./site/js/id-mapper.js << 'EOF'
          // ID mapping function to handle various filename patterns
          const idMappings = {
            // Map navigation IDs to possible content file names
            // Many-to-one mappings to handle different naming conventions
            
            // Engine Systems variations
            "engine-systems": ["engine-systems", "engines", "engine_systems", "engine", "engine-system"],
            
            // Electric Vehicles variations
            "electric-vehicles": ["electric-vehicles", "evs", "electric_vehicles", "ev", "electric-vehicle"],
            
            // Other potential variations
            "electrical-systems": ["electrical-systems", "electrical", "electrical_systems", "electrical-system"],
            "braking-systems": ["braking-systems", "brakes", "braking_systems", "braking"],
            "automobile-fundamentals": ["automobile-fundamentals", "car_basics", "car-basics", "automobile_fundamentals"],
            "history-of-automobiles": ["history-of-automobiles", "car_history", "car-history", "history"],
            "types-of-vehicles": ["types-of-vehicles", "car_types", "car-types", "types"],
            "basic-maintenance": ["basic-maintenance", "basic_maintenance", "maintenance-basic"],
            "vehicle-maintenance": ["vehicle-maintenance", "car_maintenance", "car-maintenance"],
            "emergency-repairs": ["emergency-repairs", "emergency_repairs", "repairs"]
          };
          
          // Function to try all possible file names for a given ID
          async function tryAllPossibleFiles(baseId, basePath = '') {
            // Get all possible filenames for this ID
            const possibleIds = idMappings[baseId] || [baseId];
            
            // Try each possible filename
            for (const id of possibleIds) {
              try {
                const contentPath = `${basePath}/content/${id}.html`;
                console.log(`[DITA-SPA] Trying path: ${contentPath}`);
                
                const response = await fetch(contentPath);
                if (response.ok) {
                  const content = await response.text();
                  if (content && content.trim() !== '') {
                    console.log(`[DITA-SPA] Successfully loaded content from: ${contentPath}`);
                    return content;
                  }
                }
              } catch (error) {
                console.log(`[DITA-SPA] Failed to load ${id}.html: ${error.message}`);
              }
            }
            
            // If we get here, all attempts failed
            throw new Error(`Could not load content for ${baseId} after trying all possible filenames`);
          }
          EOF

      # Step 11: Create SPA CSS with fix for duplicate headings
      - name: Create SPA CSS
        run: |
          cat > ./site/css/style.css << 'EOF'
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            display: flex;
            height: 100vh;
            width: 100%;
            overflow: hidden;
          }
          
          .sidebar {
            width: 250px;
            background-color: #f5f5f5;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid #ddd;
          }
          
          .main-content {
            flex: 1;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
          }
          
          .sidebar h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
          }
          
          .sidebar ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 15px;
          }
          
          .sidebar ul ul {
            padding-left: 20px;
            margin-top: 5px;
          }
          
          .sidebar li {
            margin-bottom: 8px;
          }
          
          .sidebar a {
            color: #2c3e50;
            text-decoration: none;
            display: block;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            cursor: pointer;
          }
          
          .sidebar a:hover {
            background-color: #e0e0e0;
          }
          
          .sidebar a.active {
            background-color: #dbeafe;
            font-weight: bold;
          }
          
          /* Improve readability in main content */
          .main-content h1, .main-content h2, .main-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
          }
          
          .main-content p {
            margin-bottom: 1em;
          }
          
          .main-content img {
            max-width: 100%;
            height: auto;
          }
          
          /* Fix for duplicate headings */
          .main-content h1:first-child + h1,
          #content h1 + h1 {
            display: none;
          }
          
          /* Fix for empty paragraph tags */
          p:empty {
            display: none;
          }
          
          /* Improve content display */
          .topic-content {
            margin-top: 1em;
          }
          
          #loading {
            display: none;
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
          }
          
          .loading #loading {
            display: block;
          }
          
          /* Add loading animation */
          .loading #content::before {
            content: "";
            display: block;
            width: 40px;
            height: 40px;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -20px;
            margin-left: -20px;
            border-radius: 50%;
            border: 3px solid #f3f3f3;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
          }
          
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
          
          /* Error styling */
          .error {
            background-color: #fff8f8;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin-bottom: 20px;
            color: #333;
          }
          
          .error h2 {
            color: #e74c3c;
            margin-top: 0;
          }
          
          /* Debug panel styling */
          #debug-panel {
            font-family: monospace;
            z-index: 1000;
            font-size: 12px;
            opacity: 0.9;
          }
          
          #debug-content div {
            border-bottom: 1px dotted #ccc;
            padding: 2px 0;
          }
          
          /* List styling improvements */
          ul, ol {
            margin-left: 20px;
            margin-bottom: 15px;
          }
          
          li {
            margin-bottom: 5px;
          }
          
          /* Make strong tags stand out better */
          strong {
            color: #2c3e50;
          }
          EOF

      # Steps 12-16 remain the same as before...
      
      # Step 12: Create SPA JavaScript Application with enhanced content loading
      - name: Create SPA Application
        run: |
          cat > ./site/js/app.js << 'EOF'
          // SPA Application with enhanced content loading
          
          // DOM Elements
          const contentEl = document.getElementById('content');
          const contentTitleEl = document.getElementById('content-title');
          const navigationEl = document.getElementById('navigation');
          
          // Base path handling for GitHub Pages
          const getBasePath = () => {
            // For GitHub Pages repository sites, we need to include the repo name in paths
            if (location.hostname.includes('github.io')) {
              const pathSegments = location.pathname.split('/');
              if (pathSegments.length > 1) {
                return '/' + pathSegments[1];
              }
            }
            return '';
          };
          
          // Current state
          let currentPage = null;
          const basePath = getBasePath();
          
          // Debug logging function
          function debug(message, data) {
            console.log(`[DITA-SPA] ${message}`, data || '');
            if (window.debugLog) {
              window.debugLog(message + (data ? ': ' + JSON.stringify(data) : ''));
            }
          }
          
          // Initialize the application
          function initApp() {
            debug('Initializing app with base path:', basePath);
            
            // Render navigation
            renderNavigation(navigationConfig);
            
            // Set up event listeners
            window.addEventListener('popstate', handlePopState);
            
            // Load initial page based on URL or default
            const initialPageId = getPageIdFromUrl() || "automotive-theories";
            debug('Initial page ID:', initialPageId);
            navigateToPage(initialPageId, false);
          }
          
          // Render the navigation menu
          function renderNavigation(items, parentEl = navigationEl) {
            debug('Rendering navigation items:', items.length);
            const ul = document.createElement('ul');
            
            items.forEach(item => {
              const li = document.createElement('li');
              
              const a = document.createElement('a');
              a.textContent = item.title;
              a.setAttribute('data-id', item.id);
              a.href = `#${item.id}`;
              a.addEventListener('click', (e) => {
                e.preventDefault();
                navigateToPage(item.id);
              });
              li.appendChild(a);
              
              // Recursively render children if any
              if (item.children && item.children.length > 0) {
                renderNavigation(item.children, li);
              }
              
              ul.appendChild(li);
            });
            
            parentEl.appendChild(ul);
          }
          
          // Navigate to a specific page
          function navigateToPage(pageId, pushState = true) {
            debug('Navigating to page:', pageId);
            
            // Update active state in navigation
            updateActiveNavItem(pageId);
            
            // Update the URL
            if (pushState) {
              history.pushState({ pageId }, '', `#${pageId}`);
            }
            
            // Show loading indicator
            document.body.classList.add('loading');
            
            // Update current page
            currentPage = pageId;
            
            // Load content
            loadContent(pageId)
              .then(content => {
                // Update title
                const title = getPageTitle(pageId);
                contentTitleEl.textContent = title;
                document.title = title;
                
                // Check content quality
                const contentLength = content.length;
                debug(`Content length: ${contentLength} characters`);
                if (contentLength < 200) {
                  debug('WARNING: Content appears to be very short, may be placeholder');
                }
                
                // Fix for duplicate headings - if title is repeated in content
                // If content starts with the same title, try to remove it
                const titleRegex = new RegExp(`<h1.*?>${title}</h1>`, 'i');
                if (titleRegex.test(content)) {
                  debug('Found duplicate title in content, removing it');
                  content = content.replace(titleRegex, '');
                }
                
                // Update content
                contentEl.innerHTML = content;
                
                // Process content after insertion
                postProcessContent();
                
                // Hide loading indicator
                document.body.classList.remove('loading');
                debug('Content loaded successfully for:', pageId);
              })
              .catch(error => {
                console.error('Error loading content:', error);
                contentEl.innerHTML = `
                  <div class="error">
                    <h2>Content Not Found</h2>
                    <p>The requested content "${pageId}" could not be loaded.</p>
                    <p>Please select another topic from the navigation menu.</p>
                    <p><small>Technical details: ${error.message}</small></p>
                  </div>
                `;
                document.body.classList.remove('loading');
              });
          }
          
          // Post-process content after loading
          function postProcessContent() {
            // Handle empty paragraphs
            const emptyParagraphs = contentEl.querySelectorAll('p:empty');
            emptyParagraphs.forEach(p => p.remove());
            
            // Fix duplicate headings
            const headings = contentEl.querySelectorAll('h1');
            if (headings.length > 1) {
              // Keep only the first heading with the same text
              const seenHeadings = new Set();
              headings.forEach(heading => {
                if (seenHeadings.has(heading.innerText)) {
                  heading.remove();
                } else {
                  seenHeadings.add(heading.innerText);
                }
              });
            }
          }
          
          // Enhanced load content function that tries multiple sources
          async function loadContent(pageId) {
            debug('Attempting to load content for:', pageId);
            
            try {
              // First try the direct ID
              const contentPath = `${basePath}/content/${pageId}.html`;
              debug('Fetching from URL:', contentPath);
              
              const response = await fetch(contentPath);
              if (response.ok) {
                const content = await response.text();
                if (content && content.trim() !== '') {
                  const contentLength = content.length;
                  if (contentLength > 200) {
                    return content; // Return if content is substantial
                  } else {
                    debug('Content found but appears to be minimal, checking alternatives');
                    // Continue to try alternatives
                  }
                }
              }
              
              // If direct ID fails or returns minimal content, try alternative approach
              if (typeof tryAllPossibleFiles === 'function') {
                debug('Trying alternative IDs');
                const alternativeContent = await tryAllPossibleFiles(pageId, basePath);
                if (alternativeContent && alternativeContent.trim() !== '') {
                  return alternativeContent;
                }
              }
              
              // Try direct DITA extraction version
              const directPath = `${basePath}/content/direct_${pageId}.html`;
              debug('Trying direct DITA extraction:', directPath);
              try {
                const directResponse = await fetch(directPath);
                if (directResponse.ok) {
                  const directContent = await directResponse.text();
                  if (directContent && directContent.trim() !== '') {
                    return directContent;
                  }
                }
              } catch (directError) {
                debug('Direct extraction not available:', directError.message);
              }
              
              // Return original content even if minimal
              return await fetch(contentPath).then(res => res.text());
            } catch (error) {
              debug('Error in loadContent:', error.message);
              
              // Last resort: try some common patterns manually
              try {
                // Try with hyphens instead of underscores
                const altId = pageId.replace(/_/g, '-');
                if (altId !== pageId) {
                  const altPath = `${basePath}/content/${altId}.html`;
                  debug('Trying alternative ID format:', altPath);
                  const altResponse = await fetch(altPath);
                  if (altResponse.ok) {
                    const content = await altResponse.text();
                    if (content && content.trim() !== '') {
                      return content;
                    }
                  }
                }
                
                // Try with underscores instead of hyphens
                const altId2 = pageId.replace(/-/g, '_');
                if (altId2 !== pageId && altId2 !== altId) {
                  const altPath2 = `${basePath}/content/${altId2}.html`;
                  debug('Trying another alternative ID format:', altPath2);
                  const altResponse2 = await fetch(altPath2);
                  if (altResponse2.ok) {
                    const content = await altResponse2.text();
                    if (content && content.trim() !== '') {
                      return content;
                    }
                  }
                }
              } catch (altError) {
                debug('Alternative ID attempts also failed');
              }
              
              throw error; // Re-throw the original error
            }
          }
          
          // Update active state in navigation
          function updateActiveNavItem(pageId) {
            // Remove active class from all nav items
            const allNavItems = document.querySelectorAll('.sidebar a');
            allNavItems.forEach(item => item.classList.remove('active'));
            
            // Add active class to current page nav item
            const activeItem = document.querySelector(`.sidebar a[data-id="${pageId}"]`);
            if (activeItem) {
              activeItem.classList.add('active');
              
              // Expand parent sections if needed
              let parent = activeItem.parentElement;
              while (parent && parent !== navigationEl) {
                if (parent.tagName === 'LI') {
                  const parentLink = parent.querySelector('a');
                  if (parentLink) {
                    parentLink.classList.add('active');
                  }
                }
                parent = parent.parentElement;
              }
            } else {
              debug('Warning: No navigation item found for:', pageId);
            }
          }
          
          // Handle popstate event (browser back/forward)
          function handlePopState(event) {
            const pageId = event.state?.pageId || getPageIdFromUrl() || 'default';
            debug('Popstate event, loading page:', pageId);
            navigateToPage(pageId, false);
          }
          
          // Get page ID from URL hash
          function getPageIdFromUrl() {
            return window.location.hash.substring(1) || null;
          }
          
          // Get page title from content manifest
          function getPageTitle(pageId) {
            if (!contentManifest[pageId]) {
              debug('Warning: No manifest entry for:', pageId);
              return pageId.split(/[-_]/).map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
              ).join(' ');
            }
            return contentManifest[pageId].title;
          }
          
          // Check content directory structure on load
          async function checkContentStructure() {
            try {
              debug('Checking for default content file...');
              const response = await fetch(`${basePath}/content/default.html`);
              if (response.ok) {
                debug('Default content exists, structure seems correct');
              } else {
                console.warn('Default content not found, may indicate path issues');
              }
            } catch (error) {
              console.error('Error checking content structure:', error);
            }
          }
          
          // Add a force reload handler to counter caching issues
          window.forceReload = function() {
            debug('Force reload requested');
            caches.keys().then(keyList => {
              return Promise.all(keyList.map(key => {
                return caches.delete(key);
              }));
            }).then(() => {
              debug('Cache cleared');
              window.location.reload(true);
            });
          };
          
          // Initialize the app when DOM is ready
          document.addEventListener('DOMContentLoaded', () => {
            debug('DOM loaded, initializing app...');
            // Check for nocache parameter to force a clean reload
            if (location.search.includes('nocache=true')) {
              debug('No-cache parameter detected, clearing cache');
              window.forceReload();
            } else {
              checkContentStructure();
              initApp();
            }
          });
          
          // Display loading error if content doesn't load within 5 seconds
          setTimeout(() => {
            if (document.body.classList.contains('loading')) {
              debug('Still loading after timeout, may indicate a problem');
              const errorMsg = document.createElement('div');
              errorMsg.className = 'error';
              errorMsg.innerHTML = `
                <h2>Content Loading Issue</h2>
                <p>The content is taking too long to load. This may indicate a path or configuration issue.</p>
                <p>Current page ID: ${currentPage}</p>
                <p>Try adding "?debug=true&nocache=true" to the URL to reload without cache.</p>
                <p><button onclick="window.forceReload()">Force Reload</button></p>
              `;
              contentEl.appendChild(errorMsg);
            }
          }, 5000);
          EOF

      # Step 13: Create main index.html
      - name: Create Index HTML
        run: |
          cat > ./site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
            <meta http-equiv="Pragma" content="no-cache">
            <meta http-equiv="Expires" content="0">
            
            <!-- Base path handling for GitHub Pages -->
            <script>
              // Dynamically set the base href based on deployment environment
              (function() {
                // For GitHub Pages repository sites
                if (location.hostname.includes('github.io')) {
                  const pathSegments = location.pathname.split('/');
                  if (pathSegments.length > 1) {
                    const basePath = '/' + pathSegments[1];
                    document.write('<base href="' + basePath + '/">');
                    console.log('[DITA-SPA] Base path set to:', basePath);
                  }
                }
              })();
              
              // Handle redirects from 404 page 
              (function() {
                var redirect = sessionStorage.redirect;
                delete sessionStorage.redirect;
                if (redirect && redirect !== location.href) {
                  var cleanPath = redirect.split('/').pop();
                  if (cleanPath) {
                    history.replaceState(null, null, "#" + cleanPath.replace('.html', ''));
                    console.log('[DITA-SPA] Redirected from:', redirect);
                  }
                }
              })();
            </script>
            
            <title>Automotive Documentation</title>
            <link rel="stylesheet" href="css/style.css">
            
            <!-- Error handling and diagnostics -->
            <script>
              window.onerror = function(message, source, lineno, colno, error) {
                console.error('[DITA-SPA] Error:', message, 'at', source, lineno, colno);
                document.getElementById('error-display') && 
                  (document.getElementById('error-display').innerHTML = 
                    '<p>Error: ' + message + '</p><p>Source: ' + source + ':' + lineno + '</p>');
                return false;
              };
            </script>
          </head>
          <body>
            <div class="sidebar">
              <h2>Navigation</h2>
              <div id="navigation"></div>
            </div>
            <div class="main-content">
              <h1 id="content-title">Loading...</h1>
              <div id="loading">Loading content...</div>
              <div id="content">
                <!-- Content will load here -->
                <!-- Initial loading message -->
                <div class="initial-loading">
                  <p>Initializing documentation viewer...</p>
                  <p><small>If content doesn't appear in a few seconds, check the console for errors.</small></p>
                </div>
              </div>
              <div id="error-display"></div>
            </div>
            
            <!-- Debug panel (hidden by default, can be shown with ?debug=true in URL) -->
            <div id="debug-panel" style="display: none; position: fixed; bottom: 0; right: 0; background: #f0f0f0; padding: 10px; border: 1px solid #ccc; max-width: 400px; max-height: 300px; overflow: auto; font-size: 12px;">
              <h4>Debug Information</h4>
              <div id="debug-content"></div>
              <hr>
              <button onclick="window.forceReload()">Force Reload</button>
            </div>
            
            <!-- Add debug panel toggle -->
            <script>
              if (location.search.includes('debug=true')) {
                document.getElementById('debug-panel').style.display = 'block';
                window.debugLog = function(msg) {
                  const panel = document.getElementById('debug-content');
                  if (panel) {
                    const line = document.createElement('div');
                    line.textContent = new Date().toISOString().substr(11, 8) + ': ' + msg;
                    panel.appendChild(line);
                    panel.scrollTop = panel.scrollHeight;
                  }
                  console.log('[DEBUG] ' + msg);
                };
                debugLog('Debug mode enabled');
                debugLog('URL: ' + location.href);
              } else {
                window.debugLog = function() {};
              }
            </script>
            
            <!-- Load JavaScript files -->
            <script src="js/id-mapper.js"></script>
            <script src="js/navigation-config.js"></script>
            <script src="js/content-manifest.js"></script>
            <script src="js/app.js"></script>
          </body>
          </html>
          EOF

      # Step 14: Create 404.html page for SPA routing
      - name: Create 404 Page for SPA Routing
        run: |
          cat > ./site/404.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
            <meta http-equiv="Pragma" content="no-cache">
            <meta http-equiv="Expires" content="0">
            <title>Redirecting...</title>
            <script>
              // Store the requested URL for processing after redirect
              sessionStorage.redirect = location.href;
              
              // Dynamically determine the correct base path
              function getBasePath() {
                if (location.hostname.includes('github.io')) {
                  const pathSegments = location.pathname.split('/');
                  if (pathSegments.length > 1) {
                    return '/' + pathSegments[1];
                  }
                }
                return '';
              }
              
              // Redirect to the main site with the correct base path
              const basePath = getBasePath();
              window.location.href = basePath + '/';
              
              // Log for debugging
              console.log('404 Redirect - Original URL:', location.href);
              console.log('404 Redirect - Base Path:', basePath);
              console.log('404 Redirect - Redirecting to:', basePath + '/');
            </script>
          </head>
          <body>
            <div style="text-align: center; font-family: Arial, sans-serif; margin-top: 100px;">
              <h1>Redirecting to documentation...</h1>
              <p>If you are not redirected automatically, <a href="/">click here</a>.</p>
            </div>
          </body>
          </html>
          EOF

      # Step 15: Debug Content Files
      - name: Debug Content Files
        run: |
          echo "Content directory listing:"
          find ./site/content -type f | sort
          echo "---------------------"
          
          # Check content quality by file size
          echo "Content file sizes:"
          find ./site/content -type f -name "*.html" | while read -r file; do
            filename=$(basename "$file")
            filesize=$(wc -c < "$file")
            if [ $filesize -lt 200 ]; then
              status=" TOO SMALL"
            else
              status=" OK"
            fi
            printf "%-30s %8d bytes  %s\n" "$filename" "$filesize" "$status"
          done

      # Step 16: Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          force_orphan: true  # Creates a clean commit without history