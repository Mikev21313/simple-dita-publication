# Step 19: Update Branch Preview Index (Main branch only) - FIXED
- name: Update Branch Preview Index
  if: github.ref == 'refs/heads/main'
  run: |
    # Create directories
    mkdir -p ./site/previews
    mkdir -p temp-metadata
    
    # Try to fetch gh-pages branch, but don't fail if it doesn't exist
    git fetch origin gh-pages || echo "Could not fetch gh-pages branch (this is normal for the first run)"
    
    # Check if the gh-pages branch exists
    if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
      echo "Getting existing metadata from gh-pages branch"
      # Try to checkout metadata, continue if it fails
      git checkout origin/gh-pages -- preview-metadata 2>/dev/null || echo "No preview-metadata directory found (this is normal for the first run)"
      
      # Copy metadata files if directory exists
      if [ -d "preview-metadata" ]; then
        cp -r preview-metadata/* temp-metadata/ 2>/dev/null || echo "No metadata files found"
      fi
    else
      echo "No gh-pages branch exists yet - this is the first deployment"
    fi
    
    # Generate updated branches.json file with any existing or new metadata
    echo "{" > branches.json
    echo "  \"last_updated\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"," >> branches.json
    echo "  \"branches\": [" >> branches.json
    
    # Add branch metadata entries
    FIRST=true
    for file in temp-metadata/*.json; do
      # Check if any files exist matching the pattern
      if [ -e "$file" ]; then
        if [ "$FIRST" = true ]; then
          FIRST=false
        else
          echo "," >> branches.json
        fi
        cat "$file" >> branches.json
      fi
    done
    
    echo "  ]" >> branches.json
    echo "}" >> branches.json
    
    # Update branches.json in site directory
    cp branches.json ./site/previews/branches.json
    echo "Branch preview index updated successfully"

# Step 20: Deploy Updated Branch Index (Main branch only)
- name: Deploy Updated Branch Index
  if: github.ref == 'refs/heads/main'
  uses: peaceiris/actions-gh-pages@v3
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}
    publish_dir: ./site/previews
    destination_dir: previews
    keep_files: true
    force_orphan: false