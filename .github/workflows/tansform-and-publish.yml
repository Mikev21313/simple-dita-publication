name: Basic DITA-OT Test

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Debug Repository Structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Repository contents:"
        ls -la
        echo "DITA source directory content:"
        ls -la dita-source/ || echo "dita-source directory not found"

    - name: Setup DITA-OT
      run: |
        mkdir -p tools
        curl -L https://github.com/dita-ot/dita-ot/releases/download/4.1.2/dita-ot-4.1.2.zip -o tools/dita-ot.zip
        unzip tools/dita-ot.zip -d tools/
        mv tools/dita-ot-4.1.2 tools/dita-ot
        
        # Verify DITA-OT installation
        echo "Verifying DITA-OT installation:"
        ls -la tools/dita-ot/bin/
        tools/dita-ot/bin/dita --version

    - name: Create Test DITA Content
      run: |
        echo "Creating minimal test DITA content..."
        mkdir -p test-dita
        
        # Create a minimal DITA map
        cat > test-dita/test.ditamap << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE map PUBLIC "-//OASIS//DTD DITA Map//EN" "map.dtd">
        <map>
          <title>Test Map</title>
          <topicref href="test-topic.dita"/>
        </map>
        EOF
        
        # Create a minimal DITA topic
        cat > test-dita/test-topic.dita << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
        <topic id="test">
          <title>Test Topic</title>
          <body>
            <p>This is a test topic.</p>
          </body>
        </topic>
        EOF
        
        echo "Test DITA content created:"
        ls -la test-dita/

    - name: Run Basic DITA-OT Test
      run: |
        echo "Running basic DITA-OT test..."
        
        # Create temp directory for logs
        mkdir -p logs
        
        # Run DITA-OT with our test content and capture all output
        tools/dita-ot/bin/dita --input=test-dita/test.ditamap --format=html5 --output=test-output --verbose > logs/dita-output.log 2>&1 || true
        
        # Display the log regardless of success/failure
        echo "==== DITA-OT OUTPUT LOG ===="
        cat logs/dita-output.log
        
        # Check if the output directory was created
        echo "==== OUTPUT DIRECTORY STATUS ===="
        if [ -d "test-output" ]; then
          echo "Output directory exists. Contents:"
          ls -la test-output/
        else
          echo "Output directory was not created!"
        fi
        
        # Look for any log files
        echo "==== DITA-OT LOG FILES ===="
        find tools/dita-ot -name "*.log" | while read logfile; do
          echo "Contents of $logfile:"
          cat "$logfile"
          echo "----------------"
        done
        
        # Check for DITA-OT temp directory
        echo "==== DITA-OT TEMP DIRECTORY ===="
        if [ -d "tools/dita-ot/temp" ]; then
          echo "Temp directory exists. Contents:"
          ls -la tools/dita-ot/temp/
        else
          echo "Temp directory does not exist!"
        fi

    - name: Test Original DITA Content
      if: always()  # Run this step even if previous steps failed
      run: |
        echo "Attempting to process original DITA content..."
        if [ -d "dita-source" ]; then
          DITAMAP=$(find dita-source -name "*.ditamap" -type f | head -1)
          if [ -n "$DITAMAP" ]; then
            echo "Found DITAMAP: $DITAMAP"
            echo "Contents of $DITAMAP:"
            cat "$DITAMAP"
            
            echo "Running DITA-OT on original content..."
            tools/dita-ot/bin/dita --input="$DITAMAP" --format=html5 --output=original-output --verbose > logs/original-output.log 2>&1 || true
            
            echo "==== ORIGINAL CONTENT OUTPUT LOG ===="
            cat logs/original-output.log
          else
            echo "No DITAMAP found in dita-source directory!"
          fi
        else
          echo "dita-source directory does not exist!"
        fi

    - name: Upload Debug Information
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: dita-debug-info
        path: |
          logs/
          test-dita/
          tools/dita-ot/temp/