name: Transform DITA to HTML

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up DITA-OT
        run: |
          wget https://github.com/dita-ot/dita-ot/releases/download/4.0.2/dita-ot-4.0.2.zip
          unzip dita-ot-4.0.2.zip
          chmod +x dita-ot-4.0.2/bin/dita

      - name: Transform DITA to HTML
        run: |
          ./dita-ot-4.0.2/bin/dita --input=dita-source/automotive.ditamap --format=html5 --output=./site
          echo "DITA transformation complete"
          
          # List files for debugging
          echo "Generated files:"
          find ./site -type f | sort

      - name: Add Layout and Remove Duplicate Navigation
        run: |
          # Create CSS directory
          mkdir -p ./site/css
          
          # Create CSS file for layout
          cat > ./site/css/style.css << 'EOF'
          body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            display: flex;
          }
          
          .sidebar {
            width: 250px;
            background-color: #f5f5f5;
            padding: 20px;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
          }
          
          .main-content {
            margin-left: 250px;
            padding: 20px;
            width: calc(100% - 250px);
          }
          
          /* Hide the duplicate navigation in the main content */
          .main-content > ul:first-of-type {
            display: none;
          }
          EOF
          
          # Create the sidebar navigation HTML
          cat > ./site/sidebar.html << 'EOF'
          <div class="sidebar">
            <h2>Navigation</h2>
            <ul>
              <li><a href="automotive-theories.html">Automotive Theories</a>
                <ul>
                  <li><a href="history-of-automobiles.html">History of Automobiles</a></li>
                  <li><a href="types-of-vehicles.html">Types of Vehicles</a></li>
                  <li><a href="automobile-fundamentals.html">Automobile Fundamentals</a></li>
                  <li><a href="major-vehicle-components.html">Major Vehicle Components</a>
                    <ul>
                      <li><a href="electrical-systems.html">Electrical Systems</a></li>
                      <li><a href="engine-systems.html">Engine Systems</a></li>
                      <li><a href="electric-vehicles.html">Electric Vehicles</a></li>
                      <li><a href="braking-systems.html">Braking Systems</a></li>
                    </ul>
                  </li>
                </ul>
              </li>
              <li><a href="basic-maintenance.html">Basic Maintenance</a></li>
              <li><a href="vehicle-maintenance.html">Vehicle Maintenance</a></li>
              <li><a href="emergency-repairs.html">Emergency Repairs</a></li>
            </ul>
          </div>
          EOF
          
          # Process each HTML file
          for file in ./site/*.html; do
            echo "Processing $file"
            
            # Create a temporary file
            temp_file=$(mktemp)
            
            # Extract content from the file, skipping the navigation section
            content=$(sed -n '/<body/,/<\/body>/p' "$file" | 
                     sed '/<body/d;/<\/body>/d' | 
                     awk '
                       BEGIN { skip=0; count=0; }
                       /<ul>/ { 
                         if (count == 0 && $0 ~ /Automotive Theories|History of Automobiles|Types of Vehicles/) {
                           skip=1; count=1; 
                         }
                       }
                       /<\/ul>/ { 
                         if (skip == 1) { 
                           skip=0; 
                         }
                       }
                       { if (skip == 0) print $0; }
                     ')
            
            # Get the title
            title=$(grep -o "<title>.*</title>" "$file" | head -1)
            
            # Create the new file with the sidebar
            cat > "$temp_file" << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            $title
            <link rel="stylesheet" href="css/style.css">
          </head>
          <body>
          $(cat ./site/sidebar.html)
          <div class="main-content">
          $content
          </div>
          </body>
          </html>
          EOF
            
            # Replace the original file
            mv "$temp_file" "$file"
          done
          
          # Clean up
          rm -f ./site/sidebar.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          force_orphan: true