name: Publish DITA with Consistent Navigation
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Set up Java
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          
      - name: Install DITA-OT
        run: |
          wget https://github.com/dita-ot/dita-ot/releases/download/3.6.1/dita-ot-3.6.1.zip
          unzip dita-ot-3.6.1.zip
          chmod +x dita-ot-3.6.1/bin/dita
          
      # Create header and footer for consistent navigation
      - name: Create header and footer
        run: |
          # Create directory for header and footer files
          mkdir -p custom-templates
          
          # Create header with consistent navigation
          cat > custom-templates/header.html << 'EOF'
          <div id="site-header">
            <div class="site-title">
              <a href="index.html">Documentation</a>
            </div>
            <nav class="main-nav">
              <ul>
                <li><a href="topics/welcome.html">Test welcome page</a></li>
                <li><a href="topics/second-topic.html">Second Section</a></li>
                <li><a href="topics/Top.html">Welcome to My Simple DITA Publication</a>
                  <ul>
                    <li><a href="topics/test_2171_manual.html">test 2171 manual</a></li>
                  </ul>
                </li>
              </ul>
            </nav>
          </div>
          <hr>
          EOF
          
          # Create footer
          cat > custom-templates/footer.html << 'EOF'
          <hr>
          <div id="site-footer">
            <p>Â© 2025 My Documentation | <a href="index.html">Home</a></p>
          </div>
          <script>
            // Highlight current page in navigation
            document.addEventListener('DOMContentLoaded', function() {
              const currentPath = window.location.pathname;
              const links = document.querySelectorAll('.main-nav a');
              
              links.forEach(link => {
                if (currentPath.endsWith(link.getAttribute('href'))) {
                  link.classList.add('active');
                  link.parentElement.classList.add('current');
                }
              });
            });
          </script>
          EOF
          
      # Create custom CSS
      - name: Create CSS
        run: |
          mkdir -p custom-templates/css
          cat > custom-templates/css/custom.css << 'EOF'
          /* Base styles */
          body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.5;
          }
          
          /* Header and navigation */
          #site-header {
            margin-bottom: 20px;
          }
          
          .site-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
          }
          
          .site-title a {
            color: #333;
            text-decoration: none;
          }
          
          /* Main navigation */
          .main-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
          }
          
          .main-nav li {
            margin: 5px 0;
            position: relative;
          }
          
          .main-nav a {
            color: #0066cc;
            text-decoration: none;
            display: block;
            padding: 5px 10px;
          }
          
          .main-nav a:hover {
            background-color: #e8e8e8;
            border-radius: 3px;
          }
          
          .main-nav a.active {
            font-weight: bold;
            background-color: #e0e0e0;
            border-radius: 3px;
          }
          
          .main-nav li.current > a {
            font-weight: bold;
          }
          
          .main-nav ul ul {
            margin-left: 20px;
            border: none;
            background: none;
            padding: 0;
          }
          
          /* Content area */
          .topictitle1 {
            font-size: 1.8em;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 15px;
          }
          
          .topictitle2 {
            font-size: 1.5em;
          }
          
          /* Footer */
          #site-footer {
            margin-top: 30px;
            color: #666;
            font-size: 0.9em;
          }
          EOF
          
      # Transform DITA to HTML with custom header and footer
      - name: Transform DITA to HTML
        run: |
          ./dita-ot-3.6.1/bin/dita \
          --input=dita-source/maps/simple-guide.ditamap \
          --format=html5 \
          --output=docs \
          --args.xhtml.toc=toc \
          --args.css=css/custom.css \
          --args.cssroot=custom-templates \
          --args.copycss=yes \
          --args.hdr=custom-templates/header.html \
          --args.ftr=custom-templates/footer.html \
          --nav-toc=partial \
          --args.outext=.html \
          --verbose
          
      # Ensure output directory exists
      - name: Check output
        run: |
          if [ ! -d "docs" ]; then
            echo "Output directory not created"
            exit 1
          fi
          
          # Check for index page
          if [ ! -f "docs/index.html" ]; then
            echo "Creating index.html..."
            cp docs/topics/welcome.html docs/index.html
            # Adjust paths in the copied file
            sed -i 's/href="css\//href="css\//g' docs/index.html
          fi
          
      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docs
          branch: gh-pages
          clean: true