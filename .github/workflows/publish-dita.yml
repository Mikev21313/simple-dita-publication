# File: .github/workflows/publish-dita.yml
name: Publish DITA to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install DITA-OT
        run: |
          wget https://github.com/dita-ot/dita-ot/releases/download/3.6.1/dita-ot-3.6.1.zip
          unzip dita-ot-3.6.1.zip
          chmod +x dita-ot-3.6.1/bin/dita

      # Transform DITA to HTML
      - name: Transform DITA to HTML
        run: |
          ./dita-ot-3.6.1/bin/dita \
          --input=dita-source/maps/simple-guide.ditamap \
          --format=html5 \
          --output=docs \
          --args.xhtml.toc=toc \
          --nav-toc=full \
          --verbose
        continue-on-error: true

      # Copy template files instead of generating HTML directly
      - name: Copy HTML template files
        run: |
          # Create CSS directory
          mkdir -p docs/css
          
          # Copy CSS from the repository if it exists, otherwise create basic CSS
          if [ -f "html-templates/toc-style.css" ]; then
            cp html-templates/toc-style.css docs/css/
          else
            echo "body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }" > docs/css/toc-style.css
            echo "a { color: #0066cc; }" >> docs/css/toc-style.css
          fi
          
          # Copy index.html from the repository if it exists
          if [ -f "html-templates/index.html" ]; then
            cp html-templates/index.html docs/
            
            # Update the file list in index.html
            file_list=""
            find docs -name "*.html" -not -name "index.html" -type f | sort | while read -r file; do
              filename=$(basename "$file")
              title=$(grep -o "<title>.*</title>" "$file" | head -1 | sed 's/<title>\(.*\)<\/title>/\1/' || echo "$filename")
              file_list="${file_list}            <li><a href=\"$filename\">$title</a></li>\n"
            done
            
            # Replace placeholder with actual file list
            sed -i "s/<!-- FILE_LIST -->/$file_list/g" docs/index.html
          fi
          
          # Add CSS link to all HTML files
          find docs -name "*.html" -type f -exec sed -i 's/<\/head>/<link rel="stylesheet" href="css\/toc-style.css"><\/head>/' {} \;

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docs
          branch: gh-pages
          clean: true
