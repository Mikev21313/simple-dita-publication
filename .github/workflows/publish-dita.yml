# File: .github/workflows/publish-dita.yml
name: Publish DITA to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Install DITA-OT
        run: |
          wget https://github.com/dita-ot/dita-ot/releases/download/3.6.1/dita-ot-3.6.1.zip
          unzip dita-ot-3.6.1.zip
          chmod +x dita-ot-3.6.1/bin/dita

      # Transform DITA to HTML with built-in TOC
      - name: Transform DITA to HTML
        run: |
          ./dita-ot-3.6.1/bin/dita \
          --input=dita-source/maps/simple-guide.ditamap \
          --format=html5 \
          --output=docs \
          --args.xhtml.toc=toc \
          --nav-toc=full \
          --args.css=custom.css \
          --verbose
        continue-on-error: true

      # Add custom CSS for styling the TOC and layout
      - name: Add custom CSS
        run: |
          mkdir -p docs/css
          echo "/* Basic styles */" > docs/css/custom.css
          echo "body { font-family: Arial, sans-serif; display: flex; flex-wrap: wrap; max-width: 1200px; margin: 0 auto; padding: 20px; }" >> docs/css/custom.css
          echo "nav[role=\"toc\"] { width: 250px; padding-right: 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; padding: 15px; }" >> docs/css/custom.css
          echo "nav[role=\"toc\"] h2 { margin-top: 0; border-bottom: 1px solid #ddd; padding-bottom: 10px; }" >> docs/css/custom.css
          echo "nav[role=\"toc\"] ul { list-style-type: none; padding-left: 0; }" >> docs/css/custom.css
          echo "nav[role=\"toc\"] ul ul { padding-left: 20px; }" >> docs/css/custom.css
          echo "nav[role=\"toc\"] li { margin-bottom: 8px; }" >> docs/css/custom.css
          echo "nav[role=\"toc\"] a { color: #0066cc; text-decoration: none; }" >> docs/css/custom.css
          echo "main { flex: 1; min-width: 0; }" >> docs/css/custom.css
          echo "@media (max-width: 768px) { body { display: block; } nav[role=\"toc\"] { width: auto; margin-bottom: 20px; } }" >> docs/css/custom.css
          
          # Apply CSS to HTML files
          find docs -name "*.html" -type f -exec sed -i 's/<\/head>/<link rel="stylesheet" href="css\/custom.css"><\/head>/' {} \;

      # Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docs
          branch: gh-pages
          clean: true
